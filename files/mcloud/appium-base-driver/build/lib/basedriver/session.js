"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _appiumSupport = require("appium-support");

var _capabilities = require("../capabilities");

var _mcloudUtils = require("../mcloud-utils");

let commands = {};

commands.createSession = async function createSession(jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  _logger.default.debug(`[MCLOUD] resetting logs`);
  const reset_log_command = `/opt/reset-logs.sh`;
  (0, _mcloudUtils.executeShell)(reset_log_command, '[MCLOUD] reset appium logs');

  //TODO: test negative cases. Seems like we handled it correctly on session finish and during appium container termination
//  _logger.default.debug(`[MCLOUD] stopping capturing artifacts before session startup`);
//  const stop_rec_command = `/opt/stop-capture-artifacts.sh`;
//  (0, _mcloudUtils.executeShell)(stop_rec_command, '[MCLOUD] stop capturing artifacts before session startup');

  if (this.sessionId !== null) {
    throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
  }

  _logger.default.debug();

  let caps;

  if (w3cCapabilities) {
    this.setProtocolW3C();

    if (jsonwpDesiredCapabilities) {
      _logger.default.debug(`W3C capabilities and MJSONWP desired capabilities were provided`);
    }

    if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
      if (!_lodash.default.isEmpty(w3cCapabilities)) {
        _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
      }

      _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

      this.setProtocolMJSONWP();
      caps = jsonwpDesiredCapabilities;
    } else {
      _logger.default.debug(`Creating session with W3C capabilities: ${JSON.stringify(w3cCapabilities, null, 2)}`);

      caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
    }
  } else {
    this.setProtocolMJSONWP();

    _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${JSON.stringify(jsonwpDesiredCapabilities, null, 2)}`);

    caps = jsonwpDesiredCapabilities || {};
  }

  caps = fixCaps(caps, this.desiredCapConstraints);
  this.validateDesiredCaps(caps);
  this.sessionId = _appiumSupport.util.uuidV4();
  this.caps = caps;
  this.opts = _lodash.default.cloneDeep(this.initialOpts);
  Object.assign(this.opts, this.caps);

  if (this.opts.noReset && this.opts.fullReset) {
    throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
  }

  if (this.opts.noReset === true) {
    this.opts.fullReset = false;
  }

  if (this.opts.fullReset === true) {
    this.opts.noReset = false;
  }

  this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
  this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

  if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
    this.opts.app = null;
  }

  if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
    this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
  }

  _logger.default.info(`Session created with session id: ${this.sessionId}`);

  _logger.default.debug(`[MCLOUD] Starting artifacts capturing for init steps`);
  const start_rec_command = `/opt/start-capture-artifacts.sh ${this.sessionId} > /tmp/video.log 2>&1`;
  (1, _mcloudUtils.executeShell)(start_rec_command, '[MCLOUD] start artifacts capturing for init steps'); // 1 error code expected as process should be killed
  // save current sessionId globally to handle negative use-case instead of desired fallbackSessionId
  process.env.sessionId = this.sessionId
  return [this.sessionId, caps];
};

commands.getSessions = async function getSessions() {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
};

commands.getSession = async function getSession() {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
};

commands.deleteSession = async function deleteSession() {
  this.clearNewCommandTimeout();

  if (this.isCommandsQueueEnabled && this.commandsQueueGuard.isBusy()) {
    for (const key of _lodash.default.keys(this.commandsQueueGuard.queues)) {
      this.commandsQueueGuard.queues[key] = [];
    }
  }

  _logger.default.debug(`[MCLOUD] stopping capturing artifacts for session ${this.sessionId}`);
  const stop_rec_command = `/opt/stop-capture-artifacts.sh ${this.sessionId}`;
  (0, _mcloudUtils.executeShell)(stop_rec_command, '[MCLOUD] stop capturing artifacts');

  await new Promise(resolve => setTimeout(resolve, 300));

  _logger.default.debug(`[MCLOUD] uploading captured artifacts`);
  const upload_video_command = `/opt/upload-artifacts.sh ${this.sessionId} >> /tmp/video.log`;
  (0, _mcloudUtils.executeShell)(upload_video_command, '[MCLOUD] upload captured artifacts');
  this.sessionId = null;
};

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  for (let cap of booleanCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value)) {
      value = value.toLowerCase();

      if (value === 'true' || value === 'false') {
        _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

        caps[cap] = value === 'true';
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  for (let cap of intCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value) && !isNaN(value)) {
      value = value.trim();
      let newValue = parseInt(value, 10);

      if (value !== `${newValue}`) {
        newValue = parseFloat(value);
      }

      _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

      caps[cap] = newValue;
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0UHJvdG9jb2xNSlNPTldQIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwiZml4Q2FwcyIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJ1dGlsIiwidXVpZFY0Iiwib3B0cyIsImNsb25lRGVlcCIsImluaXRpYWxPcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwibm9SZXNldCIsImZ1bGxSZXNldCIsIkVycm9yIiwiZmFzdFJlc2V0Iiwic2tpcFVuaW5zdGFsbCIsImFwcCIsInRyaW0iLCJpc1VuZGVmaW5lZCIsIm5ld0NvbW1hbmRUaW1lb3V0IiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImluZm8iLCJjb25zb2xlIiwic3RhcnRfcmVjX2NvbW1hbmQiLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsImlzQ29tbWFuZHNRdWV1ZUVuYWJsZWQiLCJjb21tYW5kc1F1ZXVlR3VhcmQiLCJpc0J1c3kiLCJrZXkiLCJrZXlzIiwicXVldWVzIiwic3RvcF9yZWNfY29tbWFuZCIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsInVwbG9hZF92aWRlb19jb21tYW5kIiwib3JpZ2luYWxDYXBzIiwiY2xvbmUiLCJib29sZWFuQ2FwcyIsInBpY2tCeSIsImsiLCJpc0Jvb2xlYW4iLCJjYXAiLCJ2YWx1ZSIsImlzU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJpbnRDYXBzIiwiaXNOdW1iZXIiLCJpc05hTiIsIm5ld1ZhbHVlIiwicGFyc2VJbnQiLCJwYXJzZUZsb2F0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBQSxRQUFRLENBQUNDLGFBQVQsR0FBeUIsZUFBZUEsYUFBZixDQUE4QkMseUJBQTlCLEVBQXlEQyxrQkFBekQsRUFBNkVDLGVBQTdFLEVBQThGO0FBQ3JILE1BQUksS0FBS0MsU0FBTCxLQUFtQixJQUF2QixFQUE2QjtBQUMzQixVQUFNLElBQUlDLGlCQUFPQyxzQkFBWCxDQUFrQyxpQ0FDQSwwQkFEbEMsQ0FBTjtBQUVEOztBQUVEQyxrQkFBSUMsS0FBSjs7QUFHQSxNQUFJQyxJQUFKOztBQUNBLE1BQUlOLGVBQUosRUFBcUI7QUFDbkIsU0FBS08sY0FBTDs7QUFDQSxRQUFJVCx5QkFBSixFQUErQjtBQUM3Qk0sc0JBQUlDLEtBQUosQ0FBVyxpRUFBWDtBQUNEOztBQUVELFFBQUlQLHlCQUF5QixJQUFJLENBQUNVLGdCQUFFQyxhQUFGLENBQWdCVCxlQUFoQixDQUFsQyxFQUFvRTtBQUdsRSxVQUFJLENBQUNRLGdCQUFFRSxPQUFGLENBQVVWLGVBQVYsQ0FBTCxFQUFpQztBQUMvQkksd0JBQUlPLElBQUosQ0FBVSwwRUFBeUVDLElBQUksQ0FBQ0MsU0FBTCxDQUFlYixlQUFmLENBQWdDLEVBQW5IO0FBQ0Q7O0FBQ0RJLHNCQUFJTyxJQUFKLENBQVUsOENBQVY7O0FBQ0EsV0FBS0csa0JBQUw7QUFDQVIsTUFBQUEsSUFBSSxHQUFHUix5QkFBUDtBQUNELEtBVEQsTUFTTztBQUNMTSxzQkFBSUMsS0FB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LEtBQUssR0FBR0EsS0FBSyxDQUFDcEMsSUFBTixFQUFSO0FBQ0EsVUFBSTBDLFFBQVEsR0FBR0MsUUFBUSxDQUFDUCxLQUFELEVBQVEsRUFBUixDQUF2Qjs7QUFDQSxVQUFJQSxLQUFLLEtBQU0sR0FBRU0sUUFBUyxFQUExQixFQUE2QjtBQUMzQkEsUUFBQUEsUUFBUSxHQUFHRSxVQUFVLENBQUNSLEtBQUQsQ0FBckI7QUFDRDs7QUFDRGhFLHNCQUFJTyxJQUFKLENBQVUsZUFBY3dELEdBQUksMkJBQTBCQyxLQUFNLGtCQUFpQk0sUUFBUyx1Q0FBdEY7O0FBQ0FwRSxNQUFBQSxJQUFJLENBQUM2RCxHQUFELENBQUosR0FBWU8sUUFBWjtBQUNEO0FBQ0Y7O0FBRUQsU0FBT3BFLElBQVA7QUFDRDs7ZUFFY1YsUSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlcXVpcmUtYXdhaXQgKi9cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi9wcm90b2NvbCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcHJvY2Vzc0NhcGFiaWxpdGllcyB9IGZyb20gJy4uL2NhcGFiaWxpdGllcyc7XG5pbXBvcnQgeyBleGVjdXRlU2hlbGwgfSBmcm9tICcuLi9tY2xvdWQtdXRpbHMnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuY3JlYXRlU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlc3Npb24gKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMsIGpzb253cFJlcXVpcmVkQ2FwcywgdzNjQ2FwYWJpbGl0aWVzKSB7XG4gIGlmICh0aGlzLnNlc3Npb25JZCAhPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcignQ2Fubm90IGNyZWF0ZSBhIG5ldyBzZXNzaW9uICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2hpbGUgb25lIGlzIGluIHByb2dyZXNzJyk7XG4gIH1cblxuICBsb2cuZGVidWcoKTtcblxuICAvLyBEZXRlcm1pbmUgd2VhdGhlciB3ZSBzaG91bGQgdXNlIGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgb3IgdzNjQ2FwYWJpbGl0aWVzIHRvIGdldCBjYXBzIGZyb21cbiAgbGV0IGNhcHM7XG4gIGlmICh3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICB0aGlzLnNldFByb3RvY29sVzNDKCk7XG4gICAgaWYgKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVzNDIGNhcGFiaWxpdGllcyBhbmQgTUpTT05XUCBkZXNpcmVkIGNhcGFiaWxpdGllcyB3ZXJlIHByb3ZpZGVkYCk7XG4gICAgfVxuXG4gICAgaWYgKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgJiYgIV8uaXNQbGFpbk9iamVjdCh3M2NDYXBhYmlsaXRpZXMpKSB7XG4gICAgICAvLyBJZiBXM0MgQ2FwYWJpbGl0aWVzIGFuZCBNSlNPTldQIENhcGFiaWxpdGllcyB3ZXJlIHByb3ZpZGVkIGFuZCBXM0MgY2FwcyBhcmVuJ3QgYSBwbGFpbiBvYmplY3QsXG4gICAgICAvLyBsb2cgYSB3YXJuaW5nIGFuZCBmYWxsIGJhY2sgdG8gTUpTT05XUFxuICAgICAgaWYgKCFfLmlzRW1wdHkodzNjQ2FwYWJpbGl0aWVzKSkge1xuICAgICAgICBsb2cud2FybihgRXhwZWN0ZWQgVzNDIFwiY2FwYWJpbGl0aWVzXCIgdG8gYmUgYSBKU09OIE9iamVjdCBidXQgd2FzIHByb3ZpZGVkIHdpdGg6ICR7SlNPTi5zdHJpbmdpZnkodzNjQ2FwYWJpbGl0aWVzKX1gKTtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGBGYWxsaW5nIGJhY2sgdG8gTUpTT05XUCBkZXNpcmVkIGNhcGFiaWxpdGllc2ApO1xuICAgICAgdGhpcy5zZXRQcm90b2NvbE1KU09OV1AoKTtcbiAgICAgIGNhcHMgPSBqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoYENyZWF0aW5nIHNlc3Npb24gd2l0aCBXM0MgY2FwYWJpbGl0aWVzOiAke0pTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcywgbnVsbCwgMil9YCk7XG4gICAgICBjYXBzID0gcHJvY2Vzc0NhcGFiaWxpdGllcyh3M2NDYXBhYmlsaXRpZXMsIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzLCB0aGlzLnNob3VsZFZhbGlkYXRlQ2Fwcyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRoaXMuc2V0UHJvdG9jb2xNSlNPTldQKCk7XG4gICAgbG9nLmRlYnVnKGBDcmVhdGluZyBzZXNzaW9uIHdpdGggTUpTT05XUCBkZXNpcmVkIGNhcGFiaWxpdGllczogJHtKU09OLnN0cmluZ2lmeShqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzLCBudWxsLCAyKX1gKTtcbiAgICBjYXBzID0ganNvbndwRGVzaXJlZENhcGFiaWxpdGllcyB8fCB7fTtcbiAgfVxuXG4gIGNhcHMgPSBmaXhDYXBzKGNhcHMsIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzKTtcbiAgdGhpcy52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuXG4gIHRoaXMuc2Vzc2lvbklkID0gdXRpbC51dWlkVjQoKTtcbiAgdGhpcy5jYXBzID0gY2FwcztcbiAgdGhpcy5vcHRzID0gXy5jbG9uZURlZXAodGhpcy5pbml0aWFsT3B0cyk7XG5cbiAgLy8gbWVyZ2UgY2FwcyBvbnRvIG9wdHMgc28gd2UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB3aGF0J3Mgd2hlcmVcbiAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIHRoaXMuY2Fwcyk7XG5cbiAgLy8gZGVhbCB3aXRoIHJlc2V0c1xuICAvLyBzb21lIHBlb3BsZSBsaWtlIHRvIGRvIHdlaXJkIHRoaW5ncyBieSBzZXR0aW5nIG5vUmVzZXQgYW5kIGZ1bGxSZXNldFxuICAvLyBib3RoIHRvIHRydWUsIGJ1dCB0aGlzIGlzIG1pc2d1aWRlZCBhbmQgc3RyYW5nZSwgc28gZXJyb3IgaGVyZSBpbnN0ZWFkXG4gIGlmICh0aGlzLm9wdHMubm9SZXNldCAmJiB0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlICdub1Jlc2V0JyBhbmQgJ2Z1bGxSZXNldCcgY2FwYWJpbGl0aWVzIGFyZSBtdXR1YWxseSBcIiArXG4gICAgICAgICAgICAgICAgICAgICdleGNsdXNpdmUgYW5kIHNob3VsZCBub3QgYm90aCBiZSBzZXQgdG8gdHJ1ZS4gWW91ICcgK1xuICAgICAgICAgICAgICAgICAgICBcInByb2JhYmx5IG1lYW50IHRvIGp1c3QgdXNlICdmdWxsUmVzZXQnIG9uIGl0cyBvd25cIik7XG4gIH1cbiAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ID09PSB0cnVlKSB7XG4gICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9IGZhbHNlO1xuICB9XG4gIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0ID09PSB0cnVlKSB7XG4gICAgdGhpcy5vcHRzLm5vUmVzZXQgPSBmYWxzZTtcbiAgfVxuICB0aGlzLm9wdHMuZmFzdFJlc2V0ID0gIXRoaXMub3B0cy5mdWxsUmVzZXQgJiYgIXRoaXMub3B0cy5ub1Jlc2V0O1xuICB0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCA9IHRoaXMub3B0cy5mYXN0UmVzZXQgfHwgdGhpcy5vcHRzLm5vUmVzZXQ7XG5cbiAgLy8gUHJldmVudHMgZW1wdHkgc3RyaW5nIGNhcHMgc28gd2UgZG9uJ3QgbmVlZCB0byB0ZXN0IGl0IGV2ZXJ5d2hlcmVcbiAgaWYgKHR5cGVvZiB0aGlzLm9wdHMuYXBwID09PSAnc3RyaW5nJyAmJiB0aGlzLm9wdHMuYXBwLnRyaW0oKSA9PT0gJycpIHtcbiAgICB0aGlzLm9wdHMuYXBwID0gbnVsbDtcbiAgfVxuXG4gIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLmNhcHMubmV3Q29tbWFuZFRpbWVvdXQpKSB7XG4gICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gKHRoaXMuY2Fwcy5uZXdDb21tYW5kVGltZW91dCAqIDEwMDApO1xuICB9XG5cbiAgbG9nLmluZm8oYFNlc3Npb24gY3JlYXRlZCB3aXRoIHNlc3Npb24gaWQ6ICR7dGhpcy5zZXNzaW9uSWR9YCk7XG4gIGNvbnNvbGUubG9nKCdDVVNUT00hIENSRUFURSBTRVNTSU9OJyk7XG4gIGNvbnN0IHN0YXJ0X3JlY19jb21tYW5kID0gYHNoIC9vcHQvY2FwdHVyZS1hcnRpZmFjdHMuc2ggJHt0aGlzLnNlc3Npb25JZH1gO1xuICBleGVjdXRlU2hlbGwoc3RhcnRfcmVjX2NvbW1hbmQsICdzdGFydCB2aWRlbyByZWNvcmRpbmcnKTtcblxuICByZXR1cm4gW3RoaXMuc2Vzc2lvbklkLCBjYXBzXTtcbn07XG5cbmNvbW1hbmRzLmdldFNlc3Npb25zID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbnMgKCkge1xuICBsZXQgcmV0ID0gW107XG5cbiAgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgcmV0LnB1c2goe1xuICAgICAgaWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB0aGlzLmNhcHNcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXQ7XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbiAoKSB7XG4gIGNvbnNvbGUubG9nKCdDVVNUT00hIEdFVCBTRVNTSU9OJyk7XG5cbiAgaWYgKHRoaXMuY2Fwcy5ldmVudFRpbWluZ3MpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jYXBzLCB7ZXZlbnRzOiB0aGlzLmV2ZW50SGlzdG9yeX0pO1xuICB9XG4gIHJldHVybiB0aGlzLmNhcHM7XG59O1xuXG5jb21tYW5kcy5kZWxldGVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZGVsZXRlU2Vzc2lvbiAoLyogc2Vzc2lvbklkICovKSB7XG4gIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICBpZiAodGhpcy5pc0NvbW1hbmRzUXVldWVFbmFibGVkICYmIHRoaXMuY29tbWFuZHNRdWV1ZUd1YXJkLmlzQnVzeSgpKSB7XG4gICAgLy8gc2ltcGxlIGhhY2sgdG8gcmVsZWFzZSBwZW5kaW5nIGNvbW1hbmRzIGlmIHRoZXkgZXhpc3RcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBfLmtleXModGhpcy5jb21tYW5kc1F1ZXVlR3VhcmQucXVldWVzKSkge1xuICAgICAgdGhpcy5jb21tYW5kc1F1ZXVlR3VhcmQucXVldWVzW2tleV0gPSBbXTtcbiAgICB9XG4gIH1cblxuICAvLyBzdG9wIHJlY29yZGluZ1xuICBjb25zdCBzdG9wX3JlY19jb21tYW5kID0gYHNoIC9vcHQvc3RvcC1jYXB0dXJlLWFydGlmYWN0cy5zaGA7XG4gIGV4ZWN1dGVTaGVsbChzdG9wX3JlY19jb21tYW5kLCAnc3RvcCB2aWRlbyByZWNvcmRpbmcnKTtcbiAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDMwMCkpO1xuICAvLyB1cGxvYWQgdmlkZW9cbiAgY29uc3QgdXBsb2FkX3ZpZGVvX2NvbW1hbmQgPSBgc2ggL29wdC91cGxvYWQtYXJ0aWZhY3RzLnNoICR7dGhpcy5zZXNzaW9uSWR9YDtcbiAgZXhlY3V0ZVNoZWxsKHVwbG9hZF92aWRlb19jb21tYW5kLCAndXBsb2FkIHZpZGVvIHJlY29yZGluZ3MnKTtcblxuICB0aGlzLnNlc3Npb25JZCA9IG51bGw7XG59O1xuXG5mdW5jdGlvbiBmaXhDYXBzIChvcmlnaW5hbENhcHMsIGRlc2lyZWRDYXBDb25zdHJhaW50cyA9IHt9KSB7XG4gIGxldCBjYXBzID0gXy5jbG9uZShvcmlnaW5hbENhcHMpO1xuXG4gIC8vIGJvb2xlYW4gY2FwYWJpbGl0aWVzIGNhbiBiZSBwYXNzZWQgaW4gYXMgc3RyaW5ncyAnZmFsc2UnIGFuZCAndHJ1ZSdcbiAgLy8gd2hpY2ggd2Ugd2FudCB0byB0cmFuc2xhdGUgaW50byBib29sZWFuIHZhbHVlc1xuICBsZXQgYm9vbGVhbkNhcHMgPSBfLmtleXMoXy5waWNrQnkoZGVzaXJlZENhcENvbnN0cmFpbnRzLCAoaykgPT4gay5pc0Jvb2xlYW4gPT09IHRydWUpKTtcbiAgZm9yIChsZXQgY2FwIG9mIGJvb2xlYW5DYXBzKSB7XG4gICAgbGV0IHZhbHVlID0gb3JpZ2luYWxDYXBzW2NhcF07XG4gICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAodmFsdWUgPT09ICd0cnVlJyB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJykge1xuICAgICAgICBsb2cud2FybihgQ2FwYWJpbGl0eSAnJHtjYXB9JyBjaGFuZ2VkIGZyb20gc3RyaW5nIHRvIGJvb2xlYW4uIFRoaXMgbWF5IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3JgKTtcbiAgICAgICAgY2Fwc1tjYXBdID0gKHZhbHVlID09PSAndHJ1ZScpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGludCBjYXBhYmlsaXRpZXMgYXJlIG9mdGVuIHNlbnQgaW4gYXMgc3RyaW5ncyBieSBmcmFtZXdvcmtzXG4gIGxldCBpbnRDYXBzID0gXy5rZXlzKF8ucGlja0J5KGRlc2lyZWRDYXBDb25zdHJhaW50cywgKGspID0+IGsuaXNOdW1iZXIgPT09IHRydWUpKTtcbiAgZm9yIChsZXQgY2FwIG9mIGludENhcHMpIHtcbiAgICBsZXQgdmFsdWUgPSBvcmlnaW5hbENhcHNbY2FwXTtcbiAgICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkgJiYgIWlzTmFOKHZhbHVlKSkge1xuICAgICAgdmFsdWUgPSB2YWx1ZS50cmltKCk7XG4gICAgICBsZXQgbmV3VmFsdWUgPSBwYXJzZUludCh2YWx1ZSwgMTApO1xuICAgICAgaWYgKHZhbHVlICE9PSBgJHtuZXdWYWx1ZX1gKSB7XG4gICAgICAgIG5ld1ZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7XG4gICAgICB9XG4gICAgICBsb2cud2FybihgQ2FwYWJpbGl0eSAnJHtjYXB9JyBjaGFuZ2VkIGZyb20gc3RyaW5nICgnJHt2YWx1ZX0nKSB0byBpbnRlZ2VyICgke25ld1ZhbHVlfSkuIFRoaXMgbWF5IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3JgKTtcbiAgICAgIGNhcHNbY2FwXSA9IG5ld1ZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBjYXBzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvc2Vzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9

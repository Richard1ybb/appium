"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _fs = _interopRequireDefault(require("appium-support/build/lib/fs"));

var _path = _interopRequireDefault(require("path"));

var _axios = _interopRequireDefault(require("axios"));

var _logger = _interopRequireDefault(require("./logger"));

var _child_process = require("child_process");

async function getLocalAppsFolder() {
  return process.env.APPIUM_APPS_DIR;
}

async function getSharedFolderForAppUrl(url) {
  const sub = await getLocalFileForAppUrl(url);
  const lastSlashInd = sub.lastIndexOf(_path.default.sep);
  var targetPath;

  if (lastSlashInd != -1) {
    targetPath = sub.substring(0, lastSlashInd);
  } else {
    targetPath = '';
  }

  _logger.default.info(`[MCLOUD] Target path [getSharedFolderForAppUrl]: ${targetPath}`);

  const folderExists = await _fs.default.exists(targetPath);
  if (!folderExists) await _fs.default.mkdir(targetPath, {
    recursive: true
  });
  return targetPath;
}

async function getLocalFileForAppUrl(url) {
  var sub = url.substring(url.indexOf('//') + 2);
  sub = sub.substring(sub.indexOf('/'));

  if (sub.includes('?')) {
    sub = sub.substring(0, sub.indexOf('?'));
  }

  sub = sub.replace(/\//g, _path.default.sep);

  const targetPath = _path.default.join(await getLocalAppsFolder(), sub);

  _logger.default.info(`[MCLOUD] Target path [getLocalFileForAppUrl]: ${targetPath}`);

  return targetPath;
}

async function getFileContentLength(remoteUrl) {
  const timeout = 10000;
  const retries = 5;
  const pollingInterval = 3000;
  const check_app_size_optionally = process.env.CHECK_APP_SIZE_OPTIONALLY;

  _logger.default.info(`[MCLOUD] env CHECK_APP_SIZE_OPTIONALLY=${check_app_size_optionally}`);

  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };
  var lastError;

  const getLengthRequest = async () => {
    for (var i = 0; i < retries; i++) {
      try {
        _logger.default.debug(`[MCLOUD] Making GET http call for retrieving of remote app size`);

        const {
          headers: responseHeaders
        } = await (0, _axios.default)(requestOpts);
        const responseLength = parseInt(responseHeaders['content-length'], 10);

        _logger.default.debug(`[MCLOUD] CONTENT-LENGTH for the file: ${responseLength}`);

        return responseLength;
      } catch (error) {
        lastError = error;
        console.log(`[MCLOUD] Cannot fetch info about app size. Will retry attempt in ${pollingInterval}ms`);
        await new Promise(resolve => setTimeout(resolve, pollingInterval));
      }
    }
  };

  const length = await getLengthRequest();

  if (length) {
    return length;
  } else if (check_app_size_optionally !== undefined && check_app_size_optionally === 'true') {
    _logger.default.debug(`[MCLOUD] Returning app size as undefined`);

    return undefined;
  } else {
    throw new Error(`[MCLOUD] Cannot get file content-length from ${remoteUrl} after ${retries} retry(s): ${lastError}`);
  }
}

function executeShell(shellCommand, description) {
  (0, _child_process.exec)(shellCommand, (error, stdout, stderr) => {
    if (error) {
      _logger.default.info(`[MCLOUD] ${description} error: ${error.message}`);

      return;
    }

    if (stderr) {
      _logger.default.info(`[MCLOUD] ${description} stderr: ${stderr}`);

      return;
    }

    _logger.default.info(`[MCLOUD] ${description} command was successfully executed`);
  });
}

async function parseWDAUrl() {
  const wdaEnv = process.env.WDA_ENV;

  if (wdaEnv) {
    const wdaEnvContent = await _fs.default.readFile(wdaEnv);
    const regexHost = new RegExp('export WDA_HOST=(.*)');
    var host;
    var r = String(wdaEnvContent).match(regexHost);
    if (r) host = r[1];
    const regexPort = new RegExp('export WDA_PORT=(.*)');
    var port;
    var r = String(wdaEnvContent).match(regexPort);
    if (r) port = r[1];
    return `http://${host}:${port}/status`;
  }

  return undefined;
}

async function getWDAStatus(wdaURL) {
  try {
    return (await (0, _axios.default)({
      url: wdaURL,
      method: 'GET',
      timeout: 5000
    })).data;
  } catch (e) {
    _logger.default.info(`Cannot send GET request to '${wdaURL}'. Original error: ${e.message}`);

    return undefined;
  }
}

module.exports = {
  getLocalAppsFolder,
  getSharedFolderForAppUrl,
  getLocalFileForAppUrl,
  getFileContentLength,
  executeShell,
  parseWDAUrl,
  getWDAStatus
};require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL21jbG91ZC11dGlscy5qcyJdLCJuYW1lcyI6WyJnZXRMb2NhbEFwcHNGb2xkZXIiLCJwcm9jZXNzIiwiZW52IiwiQVBQSVVNX0FQUFNfRElSIiwiZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsIiwidXJsIiwic3ViIiwiZ2V0TG9jYWxGaWxlRm9yQXBwVXJsIiwibGFzdFNsYXNoSW5kIiwibGFzdEluZGV4T2YiLCJwYXRoIiwic2VwIiwidGFyZ2V0UGF0aCIsInN1YnN0cmluZyIsImxvZ2dlciIsImluZm8iLCJmb2xkZXJFeGlzdHMiLCJmcyIsImV4aXN0cyIsIm1rZGlyIiwicmVjdXJzaXZlIiwiaW5kZXhPZiIsImluY2x1ZGVzIiwicmVwbGFjZSIsIm5vZGVQYXRoIiwiam9pbiIsImdldEZpbGVDb250ZW50TGVuZ3RoIiwicmVtb3RlVXJsIiwidGltZW91dCIsInJldHJpZXMiLCJwb2xsaW5nSW50ZXJ2YWwiLCJjaGVja19hcHBfc2l6ZV9vcHRpb25hbGx5IiwiQ0hFQ0tfQVBQX1NJWkVfT1BUSU9OQUxMWSIsInJlcXVlc3RPcHRzIiwicmVzcG9uc2VUeXBlIiwibGFzdEVycm9yIiwiZ2V0TGVuZ3RoUmVxdWVzdCIsImkiLCJkZWJ1ZyIsImhlYWRlcnMiLCJyZXNwb25zZUhlYWRlcnMiLCJyZXNwb25zZUxlbmd0aCIsInBhcnNlSW50IiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwibGVuZ3RoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJleGVjdXRlU2hlbGwiLCJzaGVsbENvbW1hbmQiLCJkZXNjcmlwdGlvbiIsInN0ZG91dCIsInN0ZGVyciIsIm1lc3NhZ2UiLCJwYXJzZVdEQVVybCIsIndkYUVudiIsIldEQV9FTlYiLCJ3ZGFFbnZDb250ZW50IiwicmVhZEZpbGUiLCJyZWdleEhvc3QiLCJSZWdFeHAiLCJob3N0IiwiciIsIlN0cmluZyIsIm1hdGNoIiwicmVnZXhQb3J0IiwicG9ydCIsImdldFdEQVN0YXR1cyIsIndkYVVSTCIsIm1ldGhvZCIsImRhdGEiLCJlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUEsZUFBZUEsa0JBQWYsR0FBb0M7QUFDaEMsU0FBT0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGVBQW5CO0FBQ0g7O0FBRUQsZUFBZUMsd0JBQWYsQ0FBd0NDLEdBQXhDLEVBQTZDO0FBQ3pDLFFBQU1DLEdBQUcsR0FBRyxNQUFNQyxxQkFBcUIsQ0FBQ0YsR0FBRCxDQUF2QztBQUVBLFFBQU1HLFlBQVksR0FBR0YsR0FBRyxDQUFDRyxXQUFKLENBQWdCQyxjQUFLQyxHQUFyQixDQUFyQjtBQUNBLE1BQUlDLFVBQUo7O0FBQ0EsTUFBR0osWUFBWSxJQUFJLENBQUMsQ0FBcEIsRUFBdUI7QUFDbkJJLElBQUFBLFVBQVUsR0FBR04sR0FBRyxDQUFDTyxTQUFKLENBQWMsQ0FBZCxFQUFpQkwsWUFBakIsQ0FBYjtBQUNILEdBRkQsTUFFTztBQUNISSxJQUFBQSxVQUFVLEdBQUcsRUFBYjtBQUNIOztBQUVERSxrQkFBT0MsSUFBUCxDQUFhLG9EQUFtREgsVUFBVyxFQUEzRTs7QUFDQSxRQUFNSSxZQUFZLEdBQUcsTUFBTUMsWUFBR0MsTUFBSCxDQUFVTixVQUFWLENBQTNCO0FBQ0EsTUFBRyxDQUFDSSxZQUFKLEVBQ0ksTUFBTUMsWUFBR0UsS0FBSCxDQUFTUCxVQUFULEVBQXFCO0FBQUNRLElBQUFBLFNBQVMsRUFBRztBQUFiLEdBQXJCLENBQU47QUFFSixTQUFPUixVQUFQO0FBQ0g7O0FBRUQsZUFBZUwscUJBQWYsQ0FBcUNGLEdBQXJDLEVBQTBDO0FBQ3RDLE1BQUlDLEdBQUcsR0FBR0QsR0FBRyxDQUFDUSxTQUFKLENBQWNSLEdBQUcsQ0FBQ2dCLE9BQUosQ0FBWSxJQUFaLElBQW9CLENBQWxDLENBQVY7QUFDQWYsRUFBQUEsR0FBRyxHQUFHQSxHQUFHLENBQUNPLFNBQUosQ0FBY1As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LEtBRlU7QUFHbEI3QyxNQUFBQSxPQUFPLEVBQUU7QUFIUyxLQUFOLENBQVAsRUFJSDhDLElBSko7QUFLRCxHQU5ILENBTUksT0FBT0MsQ0FBUCxFQUFVO0FBQ1Y3RCxvQkFBT0MsSUFBUCxDQUFhLCtCQUE4QnlELE1BQU8sc0JBQXFCRyxDQUFDLENBQUNsQixPQUFRLEVBQWpGOztBQUNBLFdBQU9QLFNBQVA7QUFDRDtBQUNOOztBQUVEMEIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQUU3RSxFQUFBQSxrQkFBRjtBQUFzQkksRUFBQUEsd0JBQXRCO0FBQWdERyxFQUFBQSxxQkFBaEQ7QUFBdUVtQixFQUFBQSxvQkFBdkU7QUFBNkYwQixFQUFBQSxZQUE3RjtBQUEyR00sRUFBQUEsV0FBM0c7QUFBd0hhLEVBQUFBO0FBQXhILENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2FwcGl1bS1zdXBwb3J0L2J1aWxkL2xpYi9mcyc7XG5pbXBvcnQgbm9kZVBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcblxuYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxBcHBzRm9sZGVyKCkge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5BUFBJVU1fQVBQU19ESVI7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNoYXJlZEZvbGRlckZvckFwcFVybCh1cmwpIHtcbiAgICBjb25zdCBzdWIgPSBhd2FpdCBnZXRMb2NhbEZpbGVGb3JBcHBVcmwodXJsKTtcblxuICAgIGNvbnN0IGxhc3RTbGFzaEluZCA9IHN1Yi5sYXN0SW5kZXhPZihwYXRoLnNlcCk7XG4gICAgdmFyIHRhcmdldFBhdGg7XG4gICAgaWYobGFzdFNsYXNoSW5kICE9IC0xKSB7XG4gICAgICAgIHRhcmdldFBhdGggPSBzdWIuc3Vic3RyaW5nKDAsIGxhc3RTbGFzaEluZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0UGF0aCA9ICcnO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKGBbTUNMT1VEXSBUYXJnZXQgcGF0aCBbZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsXTogJHt0YXJnZXRQYXRofWApXG4gICAgY29uc3QgZm9sZGVyRXhpc3RzID0gYXdhaXQgZnMuZXhpc3RzKHRhcmdldFBhdGgpO1xuICAgIGlmKCFmb2xkZXJFeGlzdHMpXG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKHRhcmdldFBhdGgsIHtyZWN1cnNpdmUgOiB0cnVlfSk7XG4gIFxuICAgIHJldHVybiB0YXJnZXRQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRMb2NhbEZpbGVGb3JBcHBVcmwodXJsKSB7XG4gICAgdmFyIHN1YiA9IHVybC5zdWJzdHJpbmcodXJsLmluZGV4T2YoJy8vJykgKyAyKVxuICAgIHN1YiA9IHN1Yi5zdWJzdHJpbmcoc3ViLmluZGV4T2YoJy8nKSk7XG4gICAgaWYoc3ViLmluY2x1ZGVzKCc/JykpIHtcbiAgICAgICAgc3ViID0gc3ViLnN1YnN0cmluZygwLCBzdWIuaW5kZXhPZignPycpKTtcbiAgICB9XG4gICAgc3ViID0gc3ViLnJlcGxhY2UoL1xcLy9nLCBwYXRoLnNlcCk7XG5cbiAgICBjb25zdCB0YXJnZXRQYXRoID0gbm9kZVBhdGguam9pbihhd2FpdCBnZXRMb2NhbEFwcHNGb2xkZXIoKSwgc3ViKTtcbiAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gVGFyZ2V0IHBhdGggW2dldExvY2FsRmlsZUZvckFwcFVybF06ICR7dGFyZ2V0UGF0aH1gKVxuICAgIHJldHVybiB0YXJnZXRQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRGaWxlQ29udGVudExlbmd0aChyZW1vdGVVcmwpIHtcbiAgICBjb25zdCB0aW1lb3V0ID0gMTAwMDA7XG4gICAgY29uc3QgcmV0cmllcyA9IDU7XG4gICAgY29uc3QgcG9sbGluZ0ludGVydmFsID0gMzAwMDtcbiAgICBjb25zdCBjaGVja19hcHBfc2l6ZV9vcHRpb25hbGx5ID0gcHJvY2Vzcy5lbnYuQ0hFQ0tfQVBQX1NJWkVfT1BUSU9OQUxMWTtcbiAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gZW52IENIRUNLX0FQUF9TSVpFX09QVElPTkFMTFk9JHtjaGVja19hcHBfc2l6ZV9vcHRpb25hbGx5fWApO1xuXG4gICAgY29uc3QgcmVxdWVzdE9wdHMgPSB7XG4gICAgICAgIHVybDogcmVtb3RlVXJsLFxuICAgICAgICByZXNwb25zZVR5cGU6ICdzdHJlYW0nLFxuICAgICAgICB0aW1lb3V0LFxuICAgIH07XG5cbiAgICAvLyBnZXR0aW5nIGNvbnRlbnQtbGVuZ3RoIHdpdGggcmV0cnlcbiAgICB2YXIgbGFzdEVycm9yO1xuICAgIGNvbnN0IGdldExlbmd0aFJlcXVlc3QgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGZvciAodmFyIGk9MDsgaTxyZXRyaWVzOyBpKyspIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGBbTUNMT1VEXSBNYWtpbmcgR0VUIGh0dHAgY2FsbCBmb3IgcmV0cmlldmluZyBvZiByZW1vdGUgYXBwIHNpemVgKTtcbiAgICAgICAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHJlc3BvbnNlSGVhZGVycyxcbiAgICAgICAgICAgICAgICB9ID0gYXdhaXQgYXhpb3MocmVxdWVzdE9wdHMpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlTGVuZ3RoID0gcGFyc2VJbnQocmVzcG9uc2VIZWFkZXJzWydjb250ZW50LWxlbmd0aCddLCAxMCk7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGBbTUNMT1VEXSBDT05URU5ULUxFTkdUSCBmb3IgdGhlIGZpbGU6ICR7cmVzcG9uc2VMZW5ndGh9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlTGVuZ3RoO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW01DTE9VRF0gQ2Fubm90IGZldGNoIGluZm8gYWJvdXQgYXBwIHNpemUuIFdpbGwgcmV0cnkgYXR0ZW1wdCBpbiAke3BvbGxpbmdJbnRlcnZhbH1tc2ApO1xuICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBwb2xsaW5nSW50ZXJ2YWwpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBsZW5ndGggPSBhd2FpdCBnZXRMZW5ndGhSZXF1ZXN0KCk7XG4gICAgaWYobGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBsZW5ndGg7XG4gICAgfSBlbHNlIGlmIChjaGVja19hcHBfc2l6ZV9vcHRpb25hbGx5ICE9PSB1bmRlZmluZWQgJiYgY2hlY2tfYXBwX3NpemVfb3B0aW9uYWxseSA9PT0gJ3RydWUnKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgW01DTE9VRF0gUmV0dXJuaW5nIGFwcCBzaXplIGFzIHVuZGVmaW5lZGApO1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgW01DTE9VRF0gQ2Fubm90IGdldCBmaWxlIGNvbnRlbnQtbGVuZ3RoIGZyb20gJHtyZW1vdGVVcmx9IGFmdGVyICR7cmV0cmllc30gcmV0cnkocyk6ICR7bGFzdEVycm9yfWApO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gZXhlY3V0ZVNoZWxsKHNoZWxsQ29tbWFuZCwgZGVzY3JpcHRpb24pIHtcbiAgICBleGVjKHNoZWxsQ29tbWFuZCwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBbTUNMT1VEXSAke2Rlc2NyaXB0aW9ufSBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBbTUNMT1VEXSAke2Rlc2NyaXB0aW9ufSBzdGRlcnI6ICR7c3RkZXJyfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5pbmZvKGBbTUNMT1VEXSAke2Rlc2NyaXB0aW9ufSBjb21tYW5kIHdhcyBzdWNjZXNzZnVsbHkgZXhlY3V0ZWRgKTtcbiAgICAgIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYXJzZVdEQVVybCgpIHtcbiAgICBjb25zdCB3ZGFFbnYgPSBwcm9jZXNzLmVudi5XREFfRU5WO1xuICAgIGlmICh3ZGFFbnYpIHtcbiAgICAgICAgY29uc3Qgd2RhRW52Q29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKHdkYUVudik7XG4gICAgICAgIGNvbnN0IHJlZ2V4SG9zdCA9IG5ldyBSZWdFeHAoJ2V4cG9ydCBXREFfSE9TVD0oLiopJyk7XG4gICAgICAgIHZhciBob3N0O1xuICAgICAgICB2YXIgciA9IFN0cmluZyh3ZGFFbnZDb250ZW50KS5tYXRjaChyZWdleEhvc3QpO1xuICAgICAgICBpZiAocilcbiAgICAgICAgICAgIGhvc3QgPSByWzFdOyBcbiAgICAgICAgY29uc3QgcmVnZXhQb3J0ID0gbmV3IFJlZ0V4cCgnZXhwb3J0IFdEQV9QT1JUPSguKiknKTtcbiAgICAgICAgdmFyIHBvcnQ7XG4gICAgICAgIHZhciByID0gU3RyaW5nKHdkYUVudkNvbnRlbnQpLm1hdGNoKHJlZ2V4UG9ydCk7XG4gICAgICAgIGlmIChyKVxuICAgICAgICAgICAgcG9ydCA9IHJbMV07IFxuICAgICAgICByZXR1cm4gYGh0dHA6Ly8ke2hvc3R9OiR7cG9ydH0vc3RhdHVzYDtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0V0RBU3RhdHVzKHdkYVVSTCkge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiAoYXdhaXQgYXhpb3Moe1xuICAgICAgICAgIHVybDogd2RhVVJMLFxuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgdGltZW91dDogNTAwMCxcbiAgICAgICAgfSkpLmRhdGE7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBDYW5ub3Qgc2VuZCBHRVQgcmVxdWVzdCB0byAnJHt3ZGFVUkx9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHsgZ2V0TG9jYWxBcHBzRm9sZGVyLCBnZXRTaGFyZWRGb2xkZXJGb3JBcHBVcmwsIGdldExvY2FsRmlsZUZvckFwcFVybCwgZ2V0RmlsZUNvbnRlbnRMZW5ndGgsIGV4ZWN1dGVTaGVsbCwgcGFyc2VXREFVcmwsIGdldFdEQVN0YXR1cyB9Il0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9tY2xvdWQtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

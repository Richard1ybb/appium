"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _fs = _interopRequireDefault(require("appium-support/build/lib/fs"));

var _path = _interopRequireDefault(require("path"));

var _axios = _interopRequireDefault(require("axios"));

var _logger = _interopRequireDefault(require("./logger"));

var _child_process = require("child_process");

async function getLocalAppsFolder() {
  return process.env.APPIUM_APPS_DIR;
}

async function getSharedFolderForAppUrl(url) {
  const sub = await getLocalFileForAppUrl(url);
  const lastSlashInd = sub.lastIndexOf(_path.default.sep);
  var targetPath;

  if (lastSlashInd != -1) {
    targetPath = sub.substring(0, lastSlashInd);
  } else {
    targetPath = '';
  }

  _logger.default.info(`[MCLOUD] Target path [getSharedFolderForAppUrl]: ${targetPath}`);

  const folderExists = await _fs.default.exists(targetPath);
  if (!folderExists) await _fs.default.mkdir(targetPath, {
    recursive: true
  });
  return targetPath;
}

async function getLocalFileForAppUrl(url) {
  var sub = url.substring(url.indexOf('//') + 2);
  sub = sub.substring(sub.indexOf('/'));

  if (sub.includes('?')) {
    sub = sub.substring(0, sub.indexOf('?'));
  }

  sub = sub.replace(/\//g, _path.default.sep);

  const targetPath = _path.default.join(await getLocalAppsFolder(), sub);

  _logger.default.info(`[MCLOUD] Target path [getLocalFileForAppUrl]: ${targetPath}`);

  return targetPath;
}

async function getFileContentLength(remoteUrl) {
  const timeout = 30000;
  const retries = 5;
  const pollingInterval = 3000;
  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };

  const getLengthRequest = async () => {
    for (var i = 0; i < retries; i++) {
      try {
        _logger.default.debug(`[MCLOUD] Making GET http call for retrieving of remote app size`);

        const {
          headers: responseHeaders
        } = await (0, _axios.default)(requestOpts);
        const responseLength = parseInt(responseHeaders['content-length'], 10);

        _logger.default.debug(`[MCLOUD] CONTENT-LENGTH for the file: ${responseLength}`);

        return responseLength;
      } catch (error) {
        console.log(`[MCLOUD] Cannot fetch info about app size. Will retry attempt in ${pollingInterval}ms`);
        await new Promise(resolve => setTimeout(resolve, pollingInterval));
      }
    }
  };

  const length = await getLengthRequest();

  if (length) {
    return length;
  } else {
    throw new Error(`[MCLOUD] Cannot get file content-length from ${remoteUrl} after ${retries} retry(s)`);
  }
}

function executeShell(shellCommand, description) {
  (0, _child_process.exec)(shellCommand, (error, stdout, stderr) => {
    if (error) {
      _logger.default.info(`[MCLOUD] ${description} error: ${error.message}`);

      return;
    }

    if (stderr) {
      _logger.default.info(`[MCLOUD] ${description} stderr: ${stderr}`);

      return;
    }

    _logger.default.info(`[MCLOUD] ${description} command was successfully executed`);
  });
}

module.exports = {
  getLocalAppsFolder,
  getSharedFolderForAppUrl,
  getLocalFileForAppUrl,
  getFileContentLength,
  executeShell
};require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL21jbG91ZC11dGlscy5qcyJdLCJuYW1lcyI6WyJnZXRMb2NhbEFwcHNGb2xkZXIiLCJwcm9jZXNzIiwiZW52IiwiQVBQSVVNX0FQUFNfRElSIiwiZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsIiwidXJsIiwic3ViIiwiZ2V0TG9jYWxGaWxlRm9yQXBwVXJsIiwibGFzdFNsYXNoSW5kIiwibGFzdEluZGV4T2YiLCJwYXRoIiwic2VwIiwidGFyZ2V0UGF0aCIsInN1YnN0cmluZyIsImxvZ2dlciIsImluZm8iLCJmb2xkZXJFeGlzdHMiLCJmcyIsImV4aXN0cyIsIm1rZGlyIiwicmVjdXJzaXZlIiwiaW5kZXhPZiIsImluY2x1ZGVzIiwicmVwbGFjZSIsIm5vZGVQYXRoIiwiam9pbiIsImdldEZpbGVDb250ZW50TGVuZ3RoIiwicmVtb3RlVXJsIiwidGltZW91dCIsInJldHJpZXMiLCJwb2xsaW5nSW50ZXJ2YWwiLCJyZXF1ZXN0T3B0cyIsInJlc3BvbnNlVHlwZSIsImdldExlbmd0aFJlcXVlc3QiLCJpIiwiZGVidWciLCJoZWFkZXJzIiwicmVzcG9uc2VIZWFkZXJzIiwicmVzcG9uc2VMZW5ndGgiLCJwYXJzZUludCIsImVycm9yIiwiY29uc29sZSIsImxvZyIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsImxlbmd0aCIsIkVycm9yIiwiZXhlY3V0ZVNoZWxsIiwic2hlbGxDb21tYW5kIiwiZGVzY3JpcHRpb24iLCJzdGRvdXQiLCJzdGRlcnIiLCJtZXNzYWdlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUEsZUFBZUEsa0JBQWYsR0FBb0M7QUFDaEMsU0FBT0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLGVBQW5CO0FBQ0g7O0FBRUQsZUFBZUMsd0JBQWYsQ0FBd0NDLEdBQXhDLEVBQTZDO0FBQ3pDLFFBQU1DLEdBQUcsR0FBRyxNQUFN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SixHQWZEOztBQWdCQSxRQUFNZ0IsTUFBTSxHQUFHLE1BQU1iLGdCQUFnQixFQUFyQzs7QUFDQSxNQUFHYSxNQUFILEVBQVc7QUFDUCxXQUFPQSxNQUFQO0FBQ0gsR0FGRCxNQUVPO0FBQ0gsVUFBTSxJQUFJQyxLQUFKLENBQVcsZ0RBQStDcEIsU0FBVSxVQUFTRSxPQUFRLFdBQXJGLENBQU47QUFDSDtBQUNKOztBQUVELFNBQVNtQixZQUFULENBQXNCQyxZQUF0QixFQUFvQ0MsV0FBcEMsRUFBaUQ7QUFDN0MsMkJBQUtELFlBQUwsRUFBbUIsQ0FBQ1QsS0FBRCxFQUFRVyxNQUFSLEVBQWdCQyxNQUFoQixLQUEyQjtBQUMxQyxRQUFJWixLQUFKLEVBQVc7QUFDUDFCLHNCQUFPQyxJQUFQLENBQWEsWUFBV21DLFdBQVksV0FBVVYsS0FBSyxDQUFDYSxPQUFRLEVBQTVEOztBQUNBO0FBQ0g7O0FBQ0QsUUFBSUQsTUFBSixFQUFZO0FBQ1J0QyxzQkFBT0MsSUFBUCxDQUFhLFlBQVdtQyxXQUFZLFlBQVdFLE1BQU8sRUFBdEQ7O0FBQ0E7QUFDSDs7QUFDRHRDLG9CQUFPQyxJQUFQLENBQWEsWUFBV21DLFdBQVksb0NBQXBDO0FBQ0QsR0FWSDtBQVdIOztBQUdESSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFBRXZELEVBQUFBLGtCQUFGO0FBQXNCSSxFQUFBQSx3QkFBdEI7QUFBZ0RHLEVBQUFBLHFCQUFoRDtBQUF1RW1CLEVBQUFBLG9CQUF2RTtBQUE2RnNCLEVBQUFBO0FBQTdGLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2FwcGl1bS1zdXBwb3J0L2J1aWxkL2xpYi9mcyc7XG5pbXBvcnQgbm9kZVBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcblxuYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxBcHBzRm9sZGVyKCkge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5BUFBJVU1fQVBQU19ESVI7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNoYXJlZEZvbGRlckZvckFwcFVybCh1cmwpIHtcbiAgICBjb25zdCBzdWIgPSBhd2FpdCBnZXRMb2NhbEZpbGVGb3JBcHBVcmwodXJsKTtcblxuICAgIGNvbnN0IGxhc3RTbGFzaEluZCA9IHN1Yi5sYXN0SW5kZXhPZihwYXRoLnNlcCk7XG4gICAgdmFyIHRhcmdldFBhdGg7XG4gICAgaWYobGFzdFNsYXNoSW5kICE9IC0xKSB7XG4gICAgICAgIHRhcmdldFBhdGggPSBzdWIuc3Vic3RyaW5nKDAsIGxhc3RTbGFzaEluZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0UGF0aCA9ICcnO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKGBbTUNMT1VEXSBUYXJnZXQgcGF0aCBbZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsXTogJHt0YXJnZXRQYXRofWApXG4gICAgY29uc3QgZm9sZGVyRXhpc3RzID0gYXdhaXQgZnMuZXhpc3RzKHRhcmdldFBhdGgpO1xuICAgIGlmKCFmb2xkZXJFeGlzdHMpXG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKHRhcmdldFBhdGgsIHtyZWN1cnNpdmUgOiB0cnVlfSk7XG4gIFxuICAgIHJldHVybiB0YXJnZXRQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRMb2NhbEZpbGVGb3JBcHBVcmwodXJsKSB7XG4gICAgdmFyIHN1YiA9IHVybC5zdWJzdHJpbmcodXJsLmluZGV4T2YoJy8vJykgKyAyKVxuICAgIHN1YiA9IHN1Yi5zdWJzdHJpbmcoc3ViLmluZGV4T2YoJy8nKSk7XG4gICAgaWYoc3ViLmluY2x1ZGVzKCc/JykpIHtcbiAgICAgICAgc3ViID0gc3ViLnN1YnN0cmluZygwLCBzdWIuaW5kZXhPZignPycpKTtcbiAgICB9XG4gICAgc3ViID0gc3ViLnJlcGxhY2UoL1xcLy9nLCBwYXRoLnNlcCk7XG5cbiAgICBjb25zdCB0YXJnZXRQYXRoID0gbm9kZVBhdGguam9pbihhd2FpdCBnZXRMb2NhbEFwcHNGb2xkZXIoKSwgc3ViKTtcbiAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gVGFyZ2V0IHBhdGggW2dldExvY2FsRmlsZUZvckFwcFVybF06ICR7dGFyZ2V0UGF0aH1gKVxuICAgIHJldHVybiB0YXJnZXRQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRGaWxlQ29udGVudExlbmd0aChyZW1vdGVVcmwpIHtcbiAgICBjb25zdCB0aW1lb3V0ID0gMzAwMDA7XG4gICAgY29uc3QgcmV0cmllcyA9IDU7XG4gICAgY29uc3QgcG9sbGluZ0ludGVydmFsID0gMzAwMDtcblxuICAgIGNvbnN0IHJlcXVlc3RPcHRzID0ge1xuICAgICAgICB1cmw6IHJlbW90ZVVybCxcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJyxcbiAgICAgICAgdGltZW91dCxcbiAgICB9O1xuXG4gICAgLy8gZ2V0dGluZyBjb250ZW50LWxlbmd0aCB3aXRoIHJldHJ5XG4gICAgY29uc3QgZ2V0TGVuZ3RoUmVxdWVzdCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgZm9yICh2YXIgaT0wOyBpPHJldHJpZXM7IGkrKykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoYFtNQ0xPVURdIE1ha2luZyBHRVQgaHR0cCBjYWxsIGZvciByZXRyaWV2aW5nIG9mIHJlbW90ZSBhcHAgc2l6ZWApO1xuICAgICAgICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogcmVzcG9uc2VIZWFkZXJzLFxuICAgICAgICAgICAgICAgIH0gPSBhd2FpdCBheGlvcyhyZXF1ZXN0T3B0cyk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VMZW5ndGggPSBwYXJzZUludChyZXNwb25zZUhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10sIDEwKTtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoYFtNQ0xPVURdIENPTlRFTlQtTEVOR1RIIGZvciB0aGUgZmlsZTogJHtyZXNwb25zZUxlbmd0aH1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VMZW5ndGg7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbTUNMT1VEXSBDYW5ub3QgZmV0Y2ggaW5mbyBhYm91dCBhcHAgc2l6ZS4gV2lsbCByZXRyeSBhdHRlbXB0IGluICR7cG9sbGluZ0ludGVydmFsfW1zYCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHBvbGxpbmdJbnRlcnZhbCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGxlbmd0aCA9IGF3YWl0IGdldExlbmd0aFJlcXVlc3QoKTtcbiAgICBpZihsZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGxlbmd0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFtNQ0xPVURdIENhbm5vdCBnZXQgZmlsZSBjb250ZW50LWxlbmd0aCBmcm9tICR7cmVtb3RlVXJsfSBhZnRlciAke3JldHJpZXN9IHJldHJ5KHMpYCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBleGVjdXRlU2hlbGwoc2hlbGxDb21tYW5kLCBkZXNjcmlwdGlvbikge1xuICAgIGV4ZWMoc2hlbGxDb21tYW5kLCAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oYFtNQ0xPVURdICR7ZGVzY3JpcHRpb259IGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0ZGVycikge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oYFtNQ0xPVURdICR7ZGVzY3JpcHRpb259IHN0ZGVycjogJHtzdGRlcnJ9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbG9nZ2VyLmluZm8oYFtNQ0xPVURdICR7ZGVzY3JpcHRpb259IGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBleGVjdXRlZGApO1xuICAgICAgfSk7XG59XG5cblxubW9kdWxlLmV4cG9ydHMgPSB7IGdldExvY2FsQXBwc0ZvbGRlciwgZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsLCBnZXRMb2NhbEZpbGVGb3JBcHBVcmwsIGdldEZpbGVDb250ZW50TGVuZ3RoLCBleGVjdXRlU2hlbGwgfSJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvbWNsb3VkLXV0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const DEFAULT_ITEM_PUSH_TIMEOUT = 30 * 1000;
const APPLICATION_NOTIFICATION_TIMEOUT = 30 * 1000;
const IOS_DEPLOY = 'ios';

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    try {
      await (0, _teen_process.exec)(IOS_DEPLOY, ['uninstall', bundleid, '--udid=' + this.udid]);
    } catch (err1) {
      throw new Error(`App is not uninstalled '${bundleid}':\n` + `  - ${err1.message}\n` + `  - ${err1.stderr || err1.stdout || err1.message}`);
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app, timeout) {
    const timer = new _appiumSupport.timing.Timer().start();

    try {
      const bundlePathOnPhone = await this.pushAppBundle(app, timeout);
      await this.installApplication(bundlePathOnPhone);
    } catch (err) {
      _logger.default.warn(`Error installing app: ${err.message}`);

      _logger.default.warn(`Falling back to '${IOS_DEPLOY}' usage`);

      try {
        await _appiumSupport.fs.which(IOS_DEPLOY);
      } catch (err1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - '${IOS_DEPLOY}' utility has not been found in PATH. Is it installed?`);
      }

      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['install', '--path=' + app, '--udid=' + this.udid]);
      } catch (err1) {
        throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - ${err1.stderr || err1.stdout || err1.message}`);
      }
    }

    _logger.default.info(`App installation succeeded after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }

  async installApplication(bundlePathOnPhone) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });

    try {
      await installationService.installApplication(bundlePathOnPhone, {
        PackageType: 'Developer'
      });

      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT, `Could not get the application installed notification within ${APPLICATION_NOTIFICATION_TIMEOUT}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async pushAppBundle(app, timeout = DEFAULT_ITEM_PUSH_TIMEOUT) {
    const timer = new _appiumSupport.timing.Timer().start();
    const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

    try {
      const bundlePathOnPhone = await this.createAppPath(afcService, app);
      await _appiumSupport.fs.walkDir(app, true, async (itemPath, isDir) => {
        const pathOnPhone = _path.default.join(bundlePathOnPhone, _path.default.relative(app, itemPath));

        if (isDir) {
          await afcService.createDirectory(pathOnPhone);
        } else {
          const readStream = _appiumSupport.fs.createReadStream(itemPath, {
            autoClose: true
          });

          const writeStream = await afcService.createWriteStream(pathOnPhone, {
            autoDestroy: true
          });
          writeStream.on('finish', writeStream.destroy);
          let pushError = null;
          const itemPushWait = new _bluebird.default((resolve, reject) => {
            writeStream.on('close', () => {
              if (pushError) {
                reject(pushError);
              } else {
                resolve();
              }
            });

            const onStreamError = e => {
              readStream.unpipe(writeStream);

              _logger.default.debug(e);

              pushError = e;
            };

            writeStream.on('error', onStreamError);
            readStream.on('error', onStreamError);
          });
          readStream.pipe(writeStream);
          await itemPushWait.timeout(timeout, `Could not push '${itemPath}' within the timeout of ${timeout}ms. ` + `Consider increasing the value of 'appPushTimeout' capability.`);
        }
      });

      _logger.default.debug(`Pushed the app files successfully after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

      return bundlePathOnPhone;
    } finally {
      afcService.close();
    }
  }

  async createAppPath(afcService, localAppPath) {
    const basename = _path.default.basename(localAppPath);

    const relativePath = _path.default.join(INSTALLATION_STAGING_DIR, basename);

    try {
      await afcService.deleteDirectory(relativePath);
    } catch (ign) {}

    await afcService.createDirectory(relativePath);
    return relativePath;
  }

  async installApp(app, timeout) {
    await this.install(app, timeout);
  }

  async isAppInstalled(bundleid) {
    try {
      let {
        stdout,
        stderr,
        code
      } = await (0, _teen_process.exec)(IOS_DEPLOY, ['apps', '--system', '--udid=' + this.udid]);

      if (stdout != null && stdout.indexOf(bundleid) !== -1) {
        _logger.default.debug(bundleid + ' is found among system apps.');

        return true;
      } else {
        _logger.default.debug(bundleid + ' is NOT found among system apps.');
      }
    } catch (err1) {
      throw new Error(`App is no installed among system apps '${bundleid}':\n` + `  - ${err1.message}\n` + `  - ${err1.stderr || err1.stdout || err1.message}`);
    }

    try {
      let {
        stdout,
        stderr,
        code
      } = await (0, _teen_process.exec)(IOS_DEPLOY, ['apps', '--udid=' + this.udid]);

      if (stdout != null && stdout.indexOf(bundleid) !== -1) {
        _logger.default.debug(bundleid + ' is found among non system apps.');

        return true;
      } else {
        _logger.default.debug(bundleid + ' is NOT found among non system apps.');
      }
    } catch (err1) {
      throw new Error(`App is no installed among non system apps '${bundleid}':\n` + `  - ${err1.message}\n` + `  - ${err1.stderr || err1.stdout || err1.message}`);
    }

    return false;
  }

  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }

        return acc;
      }, []);
    } finally {
      service.close();
    }
  }

  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJERUZBVUxUX0lURU1fUFVTSF9USU1FT1VUIiwiQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVQiLCJJT1NfREVQTE9ZIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwicmVtb3ZlIiwiYnVuZGxlaWQiLCJlcnIxIiwiRXJyb3IiLCJtZXNzYWdlIiwic3RkZXJyIiwic3Rkb3V0IiwicmVtb3ZlQXBwIiwiYnVuZGxlSWQiLCJpbnN0YWxsIiwiYXBwIiwidGltZW91dCIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImJ1bmRsZVBhdGhPblBob25lIiwicHVzaEFwcEJ1bmRsZSIsImluc3RhbGxBcHBsaWNhdGlvbiIsImVyciIsImxvZyIsIndhcm4iLCJmcyIsIndoaWNoIiwiaW5mbyIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwibm90aWZpY2F0aW9uU2VydmljZSIsInNlcnZpY2VzIiwic3RhcnROb3RpZmljYXRpb25Qcm94eVNlcnZpY2UiLCJpbnN0YWxsYXRpb25TZXJ2aWNlIiwic3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJhcHBJbnN0YWxsZWROb3RpZmljYXRpb24iLCJCIiwicmVzb2x2ZSIsIm9ic2VydmVOb3RpZmljYXRpb24iLCJub3RpZmljYXRpb24iLCJQYWNrYWdlVHlwZSIsImUiLCJjbG9zZSIsImFmY1NlcnZpY2UiLCJzdGFydEFmY1NlcnZpY2UiLCJjcmVhdGVBcHBQYXRoIiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJwYXRoT25QaG9uZSIsInBhdGgiLCJqb2luIiwicmVsYXRpdmUiLCJjcmVhdGVEaXJlY3RvcnkiLCJyZWFkU3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dG9DbG9zZSIsIndyaXRlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvRGVzdHJveSIsIm9uIiwiZGVzdHJveSIsInB1c2hFcnJvciIsIml0ZW1QdXNoV2FpdCIsInJlamVjdCIsIm9uU3RyZWFtRXJyb3IiLCJ1bnBpcGUiLCJkZWJ1ZyIsInBpcGUiLCJsb2NhbEFwcFBhdGgiLCJiYXNlbmFtZSIsInJlbGF0aXZlUGF0aCIsImRlbGV0ZURpcmVjdG9yeSIsImlnbiIsImluc3RhbGxBcHAiLCJpc0FwcEluc3RhbGxlZCIsImNvZGUiLCJpbmRleE9mIiwiZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSIsImJ1bmRsZU5hbWUiLCJzZXJ2aWNlIiwiYXBwbGljYXRpb25zIiwibGlzdEFwcGxpY2F0aW9ucyIsImFwcGxpY2F0aW9uVHlwZSIsIl8iLCJyZWR1Y2UiLCJhY2MiLCJDRkJ1bmRsZU5hbWUiLCJrZXkiLCJwdXNoIiwiZ2V0UGxhdGZvcm1WZXJzaW9uIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGtDQUFrQyxHQUFHLHdDQUEzQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLGVBQWpDO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsS0FBSyxJQUF2QztBQUNBLE1BQU1DLGdDQUFnQyxHQUFHLEtBQUssSUFBOUM7QUFDQSxNQUFNQyxVQUFVLEdBQUcsS0FBbkI7O0FBRUEsTUFBTUMsU0FBTixDQUFnQjtBQUVkQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUTtBQUNqQixTQUFLQSxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFVyxRQUFOQyxNQUFNLENBQUVDLFFBQUYsRUFBWTtBQUN0QixRQUFJO0FBQ0YsWUFBTSx3QkFBS0wsVUFBTCxFQUFpQixDQUNyQixXQURxQixFQUNSSyxRQURRLEVBRXJCLFlBQVksS0FBS0YsSUFGSSxDQUFq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QUNDLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF6QixDQUEzQjtBQUNBLGFBQU9DLGdCQUFFQyxNQUFGLENBQVNKLFlBQVQsRUFBdUIsQ0FBQ0ssR0FBRCxFQUFNO0FBQUNDLFFBQUFBO0FBQUQsT0FBTixFQUFzQkMsR0FBdEIsS0FBOEI7QUFDMUQsWUFBSUQsWUFBWSxLQUFLUixVQUFyQixFQUFpQztBQUMvQk8sVUFBQUEsR0FBRyxDQUFDRyxJQUFKLENBQVNELEdBQVQ7QUFDRDs7QUFDRCxlQUFPRixHQUFQO0FBQ0QsT0FMTSxFQUtKLEVBTEksQ0FBUDtBQU1ELEtBUkQsU0FRVTtBQUNSTixNQUFBQSxPQUFPLENBQUN0QyxLQUFSO0FBQ0Q7QUFDRjs7QUFFdUIsUUFBbEJnRCxrQkFBa0IsR0FBSTtBQUMxQixXQUFPLE1BQU1DLDJCQUFVQyxZQUFWLENBQXVCLEtBQUszRixJQUE1QixDQUFiO0FBQ0Q7O0FBN01hOztlQWdOREYsUyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuaW1wb3J0IHsgZnMsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc2VydmljZXMsIHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5jb25zdCBBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OID0gJ2NvbS5hcHBsZS5tb2JpbGUuYXBwbGljYXRpb25faW5zdGFsbGVkJztcbmNvbnN0IElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiA9ICdQdWJsaWNTdGFnaW5nJztcbmNvbnN0IERFRkFVTFRfSVRFTV9QVVNIX1RJTUVPVVQgPSAzMCAqIDEwMDA7XG5jb25zdCBBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVCA9IDMwICogMTAwMDtcbmNvbnN0IElPU19ERVBMT1kgPSAnaW9zJztcblxuY2xhc3MgSU9TRGVwbG95IHtcblxuICBjb25zdHJ1Y3RvciAodWRpZCkge1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gIH1cblxuICBhc3luYyByZW1vdmUgKGJ1bmRsZWlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoSU9TX0RFUExPWSwgW1xuICAgICAgICAndW5pbnN0YWxsJywgYnVuZGxlaWQsXG4gICAgICAgICctLXVkaWQ9JyArIHRoaXMudWRpZFxuICAgICAgXSk7XG4gICAgfSBjYXRjaCAoZXJyMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcHAgaXMgbm90IHVuaW5zdGFsbGVkICcke2J1bmRsZWlkfSc6XFxuYCArXG4gICAgICAgIGAgIC0gJHtlcnIxLm1lc3NhZ2V9XFxuYCArXG4gICAgICAgIGAgIC0gJHtlcnIxLnN0ZGVyciB8fCBlcnIxLnN0ZG91dCB8fCBlcnIxLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQXBwIChidW5kbGVJZCkge1xuICAgIGF3YWl0IHRoaXMucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGwgKGFwcCwgdGltZW91dCkge1xuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1bmRsZVBhdGhPblBob25lID0gYXdhaXQgdGhpcy5wdXNoQXBwQnVuZGxlKGFwcCwgdGltZW91dCk7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHBsaWNhdGlvbihidW5kbGVQYXRoT25QaG9uZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRXJyb3IgaW5zdGFsbGluZyBhcHA6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2cud2FybihgRmFsbGluZyBiYWNrIHRvICcke0lPU19ERVBMT1l9JyB1c2FnZWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnMud2hpY2goSU9TX0RFUExPWSk7XG4gICAgICB9IGNhdGNoIChlcnIxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgJyR7YXBwfSc6XFxuYCArXG4gICAgICAgICAgYCAgLSAke2Vyci5tZXNzYWdlfVxcbmAgK1xuICAgICAgICAgIGAgIC0gJyR7SU9TX0RFUExPWX0nIHV0aWxpdHkgaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIElzIGl0IGluc3RhbGxlZD9gKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoSU9TX0RFUExPWSwgW1xuICAgICAgICAgICdpbnN0YWxsJyxcbiAgICAgICAgICAnLS1wYXRoPScgKyBhcHAsXG4gICAgICAgICAgJy0tdWRpZD0nICsgdGhpcy51ZGlkXG4gICAgICAgIF0pO1xuICAgICAgfSBjYXRjaCAoZXJyMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBpbnN0YWxsICcke2FwcH0nOlxcbmAgK1xuICAgICAgICAgIGAgIC0gJHtlcnIubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICBgICAtICR7ZXJyMS5zdGRlcnIgfHwgZXJyMS5zdGRvdXQgfHwgZXJyMS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2cuaW5mbyhgQXBwIGluc3RhbGxhdGlvbiBzdWNjZWVkZWQgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHBsaWNhdGlvbiAoYnVuZGxlUGF0aE9uUGhvbmUpIHtcbiAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnROb3RpZmljYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBpbnN0YWxsYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBhcHBJbnN0YWxsZWROb3RpZmljYXRpb24gPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5vYnNlcnZlTm90aWZpY2F0aW9uKEFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04sIHtub3RpZmljYXRpb246IHJlc29sdmV9KTtcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgaW5zdGFsbGF0aW9uU2VydmljZS5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIHtQYWNrYWdlVHlwZTogJ0RldmVsb3Blcid9KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbi50aW1lb3V0KEFQUExJQ0FUSU9OX05PVElGSUNBVElPTl9USU1FT1VULCBgQ291bGQgbm90IGdldCB0aGUgYXBwbGljYXRpb24gaW5zdGFsbGVkIG5vdGlmaWNhdGlvbiB3aXRoaW4gJHtBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVH1tcyBidXQgd2Ugd2lsbCBjb250aW51ZWApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIHJlY2VpdmUgdGhlIG5vdGlmaWNhdGlvbi4gRXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICBpbnN0YWxsYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcHVzaEFwcEJ1bmRsZSAoYXBwLCB0aW1lb3V0ID0gREVGQVVMVF9JVEVNX1BVU0hfVElNRU9VVCkge1xuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgY29uc3QgYWZjU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh0aGlzLnVkaWQpO1xuICAgIC8vIFdlIGFyZSBwdXNoaW5nIHNlcmlhbGx5IGR1ZSB0byB0aGlzIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMzExNS4gVGhlcmUgaXMgbm90aGluZyBlbHNlIHdlIGNhbiBkbyBiZXNpZGVzIHRoaXNcbiAgICB0cnkge1xuICAgICAgY29uc3QgYnVuZGxlUGF0aE9uUGhvbmUgPSBhd2FpdCB0aGlzLmNyZWF0ZUFwcFBhdGgoYWZjU2VydmljZSwgYXBwKTtcbiAgICAgIGF3YWl0IGZzLndhbGtEaXIoYXBwLCB0cnVlLCBhc3luYyAoaXRlbVBhdGgsIGlzRGlyKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhdGhPblBob25lID0gcGF0aC5qb2luKGJ1bmRsZVBhdGhPblBob25lLCBwYXRoLnJlbGF0aXZlKGFwcCwgaXRlbVBhdGgpKTtcbiAgICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgICAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkocGF0aE9uUGhvbmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGl0ZW1QYXRoLCB7YXV0b0Nsb3NlOiB0cnVlfSk7XG4gICAgICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGhPblBob25lLCB7YXV0b0Rlc3Ryb3k6IHRydWV9KTtcbiAgICAgICAgICB3cml0ZVN0cmVhbS5vbignZmluaXNoJywgd3JpdGVTdHJlYW0uZGVzdHJveSk7XG4gICAgICAgICAgbGV0IHB1c2hFcnJvciA9IG51bGw7XG4gICAgICAgICAgY29uc3QgaXRlbVB1c2hXYWl0ID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgICBpZiAocHVzaEVycm9yKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KHB1c2hFcnJvcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IG9uU3RyZWFtRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgICAgICAgICByZWFkU3RyZWFtLnVucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICAgICAgICAgIGxvZy5kZWJ1ZyhlKTtcbiAgICAgICAgICAgICAgcHVzaEVycm9yID0gZTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB3cml0ZVN0cmVhbS5vbignZXJyb3InLCBvblN0cmVhbUVycm9yKTtcbiAgICAgICAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1FcnJvcik7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgICBhd2FpdCBpdGVtUHVzaFdhaXQudGltZW91dCh0aW1lb3V0LFxuICAgICAgICAgICAgYENvdWxkIG5vdCBwdXNoICcke2l0ZW1QYXRofScgd2l0aGluIHRoZSB0aW1lb3V0IG9mICR7dGltZW91dH1tcy4gYCArXG4gICAgICAgICAgICBgQ29uc2lkZXIgaW5jcmVhc2luZyB0aGUgdmFsdWUgb2YgJ2FwcFB1c2hUaW1lb3V0JyBjYXBhYmlsaXR5LmApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGxvZy5kZWJ1ZyhgUHVzaGVkIHRoZSBhcHAgZmlsZXMgc3VjY2Vzc2Z1bGx5IGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICByZXR1cm4gYnVuZGxlUGF0aE9uUGhvbmU7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGFmY1NlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjcmVhdGVBcHBQYXRoIChhZmNTZXJ2aWNlLCBsb2NhbEFwcFBhdGgpIHtcbiAgICBjb25zdCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUobG9jYWxBcHBQYXRoKTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBwYXRoLmpvaW4oSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSLCBiYXNlbmFtZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGFmY1NlcnZpY2UuZGVsZXRlRGlyZWN0b3J5KHJlbGF0aXZlUGF0aCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KHJlbGF0aXZlUGF0aCk7XG4gICAgcmV0dXJuIHJlbGF0aXZlUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKGFwcCwgdGltZW91dCkge1xuICAgIGF3YWl0IHRoaXMuaW5zdGFsbChhcHAsIHRpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhbiBhcHBsaWNhdGlvbiBvYmplY3QgaWYgdGVzdCBhcHAgaGFzICdidW5kbGVpZCcuXG4gICAqIFRoZSB0YXJnZXQgYnVuZGxlaWQgY2FuIGJlIFVzZXIgYW5kIFN5c3RlbSBhcHBzLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlaWQgVGhlIGJ1bmRsZUlkIHRvIGVuc3VyZSBpdCBpcyBpbnN0YWxsZWRcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyBUcnVlIGlmIHRoZSBidW5kbGVpZCBleGlzdHMgaW4gdGhlIHJlc3VsdCBvZiAnbGlzdEFwcGxpY2F0aW9ucycgbGlrZTpcbiAgICogeyBcImNvbS5hcHBsZS5QcmVmZXJlbmNlc1wiOntcbiAgICogICBcIlVJUmVxdWlyZWREZXZpY2VDYXBhYmlsaXRpZXNcIjpbXCJhcm02NFwiXSxcbiAgICogICBcIlVJUmVxdWlyZXNGdWxsU2NyZWVuXCI6dHJ1ZSxcbiAgICogICBcIkNGQnVuZGxlSW5mb0RpY3Rpb25hcnlWZXJzaW9uXCI6XCI2LjBcIixcbiAgICogICBcIkVudGl0bGVtZW50c1wiOlxuICAgKiAgICAge1wiY29tLmFwcGxlLmZyb250Ym9hcmQuZGVsZXRlLWFwcGxpY2F0aW9uLXNuYXBzaG90c1wiOnRydWUsLi5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVpZCkge1xuICAgIC8vIHZlcmlmeSBpZiBhcHAgaW5zdGFsbGVkIGFtb25nIHN5c3RlbSBmaXJzdCFcbiAgICB0cnkge1xuICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVyciwgY29kZX0gPSBhd2FpdCBleGVjKElPU19ERVBMT1ksIFtcbiAgICAgICAgJ2FwcHMnLFxuICAgICAgICAnLS1zeXN0ZW0nLFxuICAgICAgICAnLS11ZGlkPScgKyB0aGlzLnVkaWRcbiAgICAgIF0pO1xuICAgICAgaWYgKHN0ZG91dCAhPSBudWxsICYmIHN0ZG91dC5pbmRleE9mKGJ1bmRsZWlkKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGJ1bmRsZWlkICsgJyBpcyBmb3VuZCBhbW9uZyBzeXN0ZW0gYXBwcy4nKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYnVuZGxlaWQgKyAnIGlzIE5PVCBmb3VuZCBhbW9uZyBzeXN0ZW0gYXBwcy4nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFwcCBpcyBubyBpbnN0YWxsZWQgYW1vbmcgc3lzdGVtIGFwcHMgJyR7YnVuZGxlaWR9JzpcXG5gICtcbiAgICAgICAgYCAgLSAke2VycjEubWVzc2FnZX1cXG5gICtcbiAgICAgICAgYCAgLSAke2VycjEuc3RkZXJyIHx8IGVycjEuc3Rkb3V0IHx8IGVycjEubWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVyciwgY29kZX0gPSBhd2FpdCBleGVjKElPU19ERVBMT1ksIFtcbiAgICAgICAgJ2FwcHMnLFxuICAgICAgICAnLS11ZGlkPScgKyB0aGlzLnVkaWRcbiAgICAgIF0pO1xuICAgICAgaWYgKHN0ZG91dCAhPSBudWxsICYmIHN0ZG91dC5pbmRleE9mKGJ1bmRsZWlkKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGJ1bmRsZWlkICsgJyBpcyBmb3VuZCBhbW9uZyBub24gc3lzdGVtIGFwcHMuJyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKGJ1bmRsZWlkICsgJyBpcyBOT1QgZm91bmQgYW1vbmcgbm9uIHN5c3RlbSBhcHBzLicpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycjEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQXBwIGlzIG5vIGluc3RhbGxlZCBhbW9uZyBub24gc3lzdGVtIGFwcHMgJyR7YnVuZGxlaWR9JzpcXG5gICtcbiAgICAgICAgYCAgLSAke2VycjEubWVzc2FnZX1cXG5gICtcbiAgICAgICAgYCAgLSAke2VycjEuc3RkZXJyIHx8IGVycjEuc3Rkb3V0IHx8IGVycjEubWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZU5hbWUgVGhlIG5hbWUgb2YgQ0ZCdW5kbGVOYW1lIGluIEluZm8ucGxpc3RcbiAgICpcbiAgICogQHJldHVybnMge0FycmF5PHN0cmluZz59IEEgbGlzdCBvZiBVc2VyIGxldmVsIGFwcHMnIGJ1bmRsZSBpZHMgd2hpY2ggaGFzXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAnQ0ZCdW5kbGVOYW1lJyBhdHRyaWJ1dGUgYXMgJ2J1bmRsZU5hbWUnLlxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSAoYnVuZGxlTmFtZSkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxpc3RBcHBsaWNhdGlvbnMoe2FwcGxpY2F0aW9uVHlwZTogJ1VzZXInfSk7XG4gICAgICByZXR1cm4gXy5yZWR1Y2UoYXBwbGljYXRpb25zLCAoYWNjLCB7Q0ZCdW5kbGVOYW1lfSwga2V5KSA9PiB7XG4gICAgICAgIGlmIChDRkJ1bmRsZU5hbWUgPT09IGJ1bmRsZU5hbWUpIHtcbiAgICAgICAgICBhY2MucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRQbGF0Zm9ybVZlcnNpb24gKCkge1xuICAgIHJldHVybiBhd2FpdCB1dGlsaXRpZXMuZ2V0T1NWZXJzaW9uKHRoaXMudWRpZCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSU9TRGVwbG95O1xuIl0sImZpbGUiOiJsaWIvaW9zLWRlcGxveS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
